```{r knitr_utils, include=FALSE}
#| renv.ignore: TRUE

knitr::knit_hooks$set(test = function(options, envir, before = FALSE) {
  if (isFALSE(testthat::is_checking() || testthat::is_testing())) return(NULL)
  if (isFALSE(before)) {
    if (!exists("tenv", envir = envir)) {
      envir$tenv <- new.env()
    }
    for (i in seq_along(options$test)) {
      expr <- substitute(tenv$id <- var, list(id = names(options$test)[i], var = as.name(options$test[[i]])))
      eval(expr, envir = envir)
    }
  }
})

knitr::opts_template$set(
  include_if_testing = list(
    eval = isTRUE(testthat::is_checking() || testthat::is_testing()),
    cache = FALSE
  ),
  skip_if_testing = list(
    eval = isFALSE(testthat::is_checking() || testthat::is_testing())
  ),
  app = list(
    webshot = "webshot2",
    screenshot.force = TRUE,
    screenshot.opts = list(delay = 5),
    dev = "png",
    fig.width = 15,
    cache = FALSE,
    message = FALSE,
    tidy = function(code, ...) {
      gsub(
        pattern = "#\\s?nolint.*|#\\s?styler:.*",
        replacement = "",
        code
      )
    },
    R.options = list(
      teal.log_level = "FATAL"
    )
  )
)
```
