---
title: PKPG06
subtitle: Boxplot of Metabolite to Parent Ratios by Treatment
---

------------------------------------------------------------------------

::: panel-tabset
## Data Setup

```{r setup, message=FALSE}
#| code-fold: show

library(dplyr)
library(scda)
library(ggplot2)
library(tidyr)
library(tern)
library(nestcolor)

adpp <- synthetic_cdisc_dataset("latest", "adpp")

# Filter NAs
adpp <- adpp %>%
  filter(PPSPEC != "NA" & PARAM != "NA" & PPCAT != "NA") %>%
  filter(PARAMCD == "CMAX" | PARAMCD == "AUCIFO", AVISITN == 1)

# filter data by PPCAT and calculate ratio
anl_x <- adpp %>%
  filter(PPCAT %in% c("Metabolite Drug X", "Plasma Drug X")) %>%
  pivot_wider(
    id_cols = c(USUBJID, ACTARM, PARAMCD, AVISIT),
    names_from = PPCAT,
    values_from = AVAL
  ) %>%
  mutate(ratio = `Metabolite Drug X` / `Plasma Drug X`) %>%
  filter(!is.na(ratio), ratio != Inf)

anl_y <- adpp %>%
  filter(PPCAT %in% c("Metabolite Drug Y", "Plasma Drug Y")) %>%
  pivot_wider(
    id_cols = c(USUBJID, ACTARM, PARAMCD, AVISIT),
    names_from = PPCAT,
    values_from = AVAL
  ) %>%
  mutate(ratio = `Metabolite Drug Y` / `Plasma Drug Y`) %>%
  filter(!is.na(ratio), ratio != Inf)
```

## Plot with Whiskers at Â±1.5 <br/> Times Inter-Quartile Range

#### Drug X Boxplot

```{r, warning=FALSE}
p <- ggplot(anl_x, aes(x = PARAMCD, y = ratio, fill = ACTARM, label = USUBJID)) +
  geom_boxplot(outlier.size = 2) +
  stat_boxplot(geom = "errorbar") +
  stat_summary(geom = "point", fun = "mean", col = "black", size = 5, shape = 8, position = position_dodge(0.75)) +
  geom_text(
    data = . %>% group_by(PARAMCD, ACTARM) %>% filter(ratio %in% boxplot.stats(ratio)$out),
    aes(x = PARAMCD, y = ratio, label = USUBJID, col = factor(ACTARM)),
    size = 3, hjust = -0.2, position = position_dodge(0.75), show.legend = F
  ) +
  labs(
    title = "Boxplot of Metabolite to Parent Ratios by Treatment",
    subtitle = paste0("Analyte: Plasma Drug X, Metabolite Drug X ", "\nPK Parameter: ", as.character(paste(unique(anl_x$PARAMCD), collapse = ", ")), "\nVisit: ", as.character((unique(anl_x$AVISIT)))),
    caption = "Program: \nOutput:",
    x = "Parameter",
    y = "Metabolite to Parent Ratio"
  ) +
  theme(plot.caption = element_text(hjust = 0)) +
  theme_nest()

# PKPG06
p
```

#### Drug Y Boxplot

```{r, warning=FALSE}
p <- ggplot(anl_y, aes(x = PARAMCD, y = ratio, fill = ACTARM, label = USUBJID)) +
  geom_boxplot(outlier.size = 2) +
  stat_boxplot(geom = "errorbar") +
  stat_summary(geom = "point", fun = "mean", col = "black", size = 5, shape = 8, position = position_dodge(0.75)) +
  geom_text(
    data = . %>% group_by(PARAMCD, ACTARM) %>% filter(ratio %in% boxplot.stats(ratio)$out),
    aes(x = PARAMCD, y = ratio, label = USUBJID, color = ACTARM),
    size = 3, hjust = -0.2, position = position_dodge(0.75), show.legend = F
  ) +
  labs(
    title = "Boxplot of Metabolite to Parent Ratios by Treatment",
    subtitle = paste0("Analyte: Plasma Drug Y, Metabolite Drug Y ", "\nPK Parameter: ", as.character(paste(unique(anl_y$PARAMCD), collapse = ", ")), "\nVisit: ", as.character((unique(anl_y$AVISIT)))),
    caption = "Program: \nOutput:",
    x = "Parameter",
    y = "Metabolite to Parent Ratio"
  ) +
  theme(plot.caption = element_text(hjust = 0)) +
  theme_nest()

# result
p
```

## Plot with Whiskers at <br/> Minimum and Maximum Values

```{r, warning=FALSE}
# whiskers are formed with the minimum and maximum values
p <- ggplot(anl_x, aes(x = PARAMCD, y = ratio, fill = ACTARM, label = USUBJID)) +
  geom_boxplot(outlier.size = 0) +
  stat_boxplot(geom = "errorbar", coef = NULL) +
  stat_summary(geom = "point", fun = "mean", col = "black", size = 5, shape = 8, position = position_dodge(0.75)) +
  labs(
    title = "Boxplot of Metabolite to Parent Ratios by Treatment",
    subtitle = paste0("Analyte: Plasma Drug X, Metabolite Drug X ", "\nPK Parameter: ", as.character(paste(unique(anl_x$PARAMCD), collapse = ", ")), "\nVisit: ", as.character((unique(anl_x$AVISIT)))),
    caption = "Program:\nOutput:",
    x = "Parameter",
    y = "Metabolite to Parent Ratio"
  ) +
  theme(plot.caption = element_text(hjust = 0)) +
  theme_nest()

# result
p
```

## Plot with Whiskers at <br/> 5th and 95th Percentiles

```{r, warning=FALSE}
# functions to calculate custom quantiles and outliers
quantiles <- function(x) {
  quant <- quantile(x, probs = c(0.05, 0.25, 0.5, 0.75, 0.95))
  names(quant) <- c("ymin", "lower", "middle", "upper", "ymax")
  quant
}

outliers <- function(x) {
  return(x < quantile(x, 0.05) | x > quantile(x, 0.95))
}

p <- ggplot(anl_x, aes(factor(PARAMCD), ratio, fill = factor(ACTARM), label = USUBJID)) +
  stat_summary(
    fun.data = quantiles, geom = "boxplot",
    position = position_dodge(1)
  ) +
  stat_summary(geom = "point", fun = "mean", col = "black", size = 5, shape = 8, position = position_dodge(1)) +
  stat_summary(
    fun.data = quantiles, geom = "errorbar",
    position = position_dodge(1)
  ) +
  geom_point(
    data = . %>% group_by(PARAMCD, ACTARM) %>%
      mutate(outlier = ifelse(outliers(ratio), ratio, as.numeric(NA))),
    aes(x = PARAMCD, y = outlier), na.rm = T,
    size = 2, position = position_dodge(1), show.legend = F
  ) +
  geom_text(
    data = . %>% group_by(PARAMCD, ACTARM) %>%
      mutate(outlier = ifelse(outliers(ratio), ratio, as.numeric(NA))),
    aes(x = PARAMCD, y = outlier, label = USUBJID, color = ACTARM), na.rm = T,
    size = 3, hjust = -0.2, vjust = 1, position = position_dodge(1), show.legend = F
  ) +
  labs(
    title = "Boxplot of Metabolite to Parent Ratios by Treatment",
    subtitle = paste0("Analyte: Plasma Drug X, Metabolite Drug X ", "\nPK Parameter: ", as.character(paste(unique(anl_x$PARAMCD), collapse = ", ")), "\nVisit: ", as.character((unique(anl_x$AVISIT)))),
    caption = "Program: \nOutput:",
    x = "Parameter",
    y = "Metabolite to Parent Ratio"
  ) +
  theme(plot.caption = element_text(hjust = 0)) +
  theme_nest()

# result
p
```

## Teal

```{r teal, message=FALSE}
#| code-fold: show

# In progress
```

{{< include ../../si.qmd >}}

:::
